<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Playlist Setup</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/mustache@4.2.0/mustache.min.js"></script>
    <style>
        h2 {
            margin-bottom: 0px !important;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background-color: #f7f7f7;
            color: #000000;
            padding: 0px;
            display: flex;
            justify-content: space-between;
            margin: 0;
            box-sizing: border-box;
        }

        /* Layout: Two columns */
        #container {
            display: flex;
            width: 100%;
            justify-content: space-between;
            height: 98vh;
        }

        /* Preview section */
        #preview-section {
            width: 70%;
            overflow: hidden;
            padding: 20px;
            margin: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
            display: flex;
            flex-direction: column;
            justify-content: center;
            /* Center horizontally */
            align-items: center;
            /* Center vertically */
            transition: background-color 0.3s ease, color 0.3s ease;
            height: 100%;
        }

        #player-container {
            background-color: #282828;
            border-radius: 20px;
            border: 5px solid #575757;
            overflow: hidden;
            width: 90%;
            max-width: 972px;
            /* Adjust width as necessary */
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
            transition: background-color 0.3s ease;
        }

        #playlist-main-display {
            display: flex;
            align-items: center;
            padding: 10px;
            justify-content: space-between;
        }

        .album-cover img {
            width: 250px;
            height: 250px;
            object-fit: cover;
            padding: 10px;
        }

        .track-info {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: space-between;
            width: 100%;
            color: #ffffff;
            transition: color 0.3s ease;
        }

        .player-controls {
            display: flex;
            margin-top: 20px;
        }

        .player-controls button {
            background: none;
            border: none;
            cursor: pointer;
        }

        .player-controls img {
            width: 30px;
            height: 30px;
            filter: invert(1);
            transition: filter 0.3s ease;
        }


        .pointer {
            cursor: pointer;
        }

        .audio-player {
            display: flex;
            align-items: center;
            margin-bottom: 0px;
            padding-left: 15px;
            padding-right: 15px;
        }

        .track-play-icon,
        .track-pause-icon {
            filter: invert(1);
            transition: filter 0.3s ease;
        }

        .js-audio-toggle {
            margin-right: 10px;
            display: flex;
        }

        .waveform-container {
            flex-grow: 1;
            width: 80%;
            /* Set to 100% of its container width */
            padding-bottom: 10px;
        }

        #waveform {
            padding-bottom: 10px;
        }

        #tracklist {
            list-style: none;
            padding: 0;
            margin: 0;
            background-color: #242424;
            width: 100%;
            max-height: 250px;
            min-height: 100px;
            overflow-y: auto;
            transition: background-color 0.3s ease;
        }

        #tracklist li {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            margin: 0;
            cursor: pointer;
            border-top: 1px solid #ccc;
            background-color: #242424;
            transition: background-color 0.3s ease;
            width: 100%;
            /* Ensure full width inside the container */
            box-sizing: border-box;
            /* Ensure padding doesnâ€™t affect the width */
            position: relative;
        }

        .track-number {
            width: 30px;
            /* Space reserved for the number or icons */
            text-align: center;
        }

        .track-number img {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        .track-number-text {
            display: block;
            color: #ffffff;
            font-weight: bold;
            transition: filter 0.3s ease;
        }

        #tracklist li:hover .track-number .track-number-text {
            display: none;
            /* Hide the track number on hover */
        }

        #tracklist li:hover .track-number .play-icon {
            display: inline-block;
            /* Show play icon on hover */
        }

        .playing .track-number-text {
            display: none;
            /* Hide the track number when playing */
        }

        .playing .pause-icon {
            display: inline-block;
            /* Show pause icon when playing */
        }

        #tracklist li.playing {
            background-color: #1d1d1d;
            /* Highlight currently playing track */
        }

        .track-details {
            display: flex;
            flex-direction: column;
            margin-left: 15px;
            /* Adds space between the track number and the track details */
            flex-grow: 1;
            /* Make the track details take up the remaining space */
            text-align: left;
        }

        .track-title {
            font-size: 16px;
            font-weight: bold;
            color: #ffffff;
            transition: color 0.3s ease;
        }

        .track-artist {
            font-size: 12px;
            color: #666;
            margin-top: 2px;
        }

        .track-time {
            font-size: 14px;
            color: #ffffff;
            transition: color 0.3s ease;
            white-space: nowrap;
        }

        #tracklist li:hover {
            background-color: #1d1d1d;
        }

        #embed-button {
            margin: 20px;
            width: 90%;
            padding: 20px;
            font-size: 20px;
            font-weight: 600;
        }

        /* Setup section */
        #setup-section {
            width: 30%;
            padding: 20px;
            background-color: #ffffff;
            margin: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            color: #000000;
            display: flex;
            flex-direction: column;
            align-items: center;
            /* Center the form horizontally */
            height: 100%;
            overflow-y: auto;
            /* Enable vertical scrolling */
        }

        /* Style for track item list */
        .track-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 5px;
            background-color: #fff;
            border-radius: 5px;
            margin-bottom: 10px;
            box-shadow: 0 1px 5px rgba(0, 0, 0, 0.1);
            width: 100%;
        }

        /* Smaller "x" for delete */
        .delete-btn {
            background: none;
            border: none;
            font-size: 14px;
            color: red;
            cursor: pointer;
        }

        /* Up/Down arrows for moving tracks */
        .move-btn {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 14px;
            color: #000;
        }

        .move-btn i {
            font-size: 18px;
            color: #000;
        }

        h1 {
            text-align: center;
            color: #000000;
        }

        form {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        label {
            font-size: 14px;
            font-weight: bold;
        }

        input[type="text"],
        input[type="file"],
        input[type="color"] {
            width: 95%;
            padding: 10px;
            margin-top: 5px;
            border: 1px solid #ccc;
            border-radius: 5px;
            color: #000000;
        }

        button {
            padding: 10px 20px;
            background-color: #000000;
            color: #fff;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            text-align: center;
        }

        .delete-btn:hover,
        .move-btn:hover {
            background-color: #f7f7f7;
        }

        button:hover {
            background-color: #1d1d1d;
        }

        #track-list {
            margin-top: -15px;
        }

        .track-item {
            display: flex;
            justify-content: space-between;
            padding: 10px;
            background-color: #fff;
            border-radius: 5px;
            margin-bottom: 10px;
            box-shadow: 0 1px 5px rgba(0, 0, 0, 0.1);
        }

        .track-item span {
            flex: 1;
        }

        /* Light theme toggle styles */
        .light-theme #player-container {
            background-color: #ffffff;
        }

        .light-theme #tracklist {
            background-color: #f7f7f7;
        }

        .light-theme #tracklist li {
            background-color: #f7f7f7;
        }

        .light-theme #tracklist li:hover {
            background-color: #a8a8a8;
        }

        .light-theme .track-title,
        .light-theme .track-time,
        .light-theme .track-info h2,
        .light-theme .track-info h3,
        .light-theme .track-number-text {
            color: #000000;
            /* Change album name, artist name, and text to black in light theme */
        }

        .light-theme .player-controls img,
        .light-theme .track-play-icon,
        .light-theme .track-pause-icon {
            filter: invert(0);
            /* Black icons for light theme */
        }

        #theme-selector {
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        #playlist-setup-form>div:nth-child(4)>div>button,
        #theme-toggle {
            margin-top: 10px;
        }

        @media (max-width: 768px) {

            #playlist-main-display {
                display: flex;
                align-items: center;
                padding: 5px;
                justify-content: space-between;
            }

            .album-cover img {
                width: 150px;
                height: 150px;
                object-fit: cover;
                padding: 10px;
            }

            .track-info {
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: space-between;
                width: 100%;
                color: #ffffff;
                transition: color 0.3s ease;
            }

            .player-controls {
                display: flex;
                margin-top: 0px;
            }

            .player-controls button {
                background: none;
                border: none;
                cursor: pointer;
            }

            .player-controls img {
                width: 30px;
                height: 30px;
                filter: invert(1);
                transition: filter 0.3s ease;
            }
        }
    </style>
</head>

<body>
    <div id="container">
        <!-- Preview section -->
        <div id="preview-section">
            <div id="player-container">
                <div id="playlist-main-display">
                    <div class="album-cover">
                        <img id="album-art-preview" src="https://via.placeholder.com/100" alt="Album Cover">
                    </div>
                    <div class="track-info">
                        <h2 id="preview-album-name">Album Name</h2>
                        <h3 id="preview-artist-name">Artist Name</h3>
                        <div class="player-controls">
                            <button id="prev-btn">
                                <img src="https://storage.googleapis.com/msgsndr/5KgPcYXxhFJNe6A0vTLj/media/66e094e7085c2a85b13edd15.svg"
                                    alt="Prev">
                            </button>
                            <button id="play-pause-btn">
                                <img id="play-icon"
                                    src="https://storage.googleapis.com/msgsndr/5KgPcYXxhFJNe6A0vTLj/media/66e094e7ea125b3b69e4aa59.svg"
                                    alt="Play">
                                <img id="pause-icon"
                                    src="https://storage.googleapis.com/msgsndr/5KgPcYXxhFJNe6A0vTLj/media/66e094e730211d65ad550edf.svg"
                                    alt="Pause" style="display: none;">
                            </button>
                            <button id="next-btn">
                                <img src="https://storage.googleapis.com/msgsndr/5KgPcYXxhFJNe6A0vTLj/media/66e094e7527063dd42faa614.svg"
                                    alt="Next">
                            </button>
                        </div>
                    </div>

                </div>

                <div id="waveform">
                    <div class="audio-player">
                        <div class="waveform-container"
                            data-audio-src="https://storage.googleapis.com/msgsndr/L5RJ1dq0vnvdiWPELZDP/media/66da435f7b3dde51865baf98.mpeg">
                        </div>
                    </div>
                </div>

                <ul id="tracklist">
                </ul>
            </div>
            <button id="embed-button" class="btn">Get Embed Code</button>
            <!-- Modal structure -->
            <div id="embed-modal" class="modal" style="display: none;">
                <div class="modal-content">
                    <span class="close-modal">&times;</span>
                    <h2>Embed Code</h2>
                    <textarea id="embed-code-textarea" readonly style="width: 100%; height: 100px;">
                        <link rel="stylesheet" href="https://crowdmesh.github.io/wsplaylist/playlist.css">
                        <div id="playlist-widget">
                        <!-- PLAYER_HTML_PLACEHOLDER -->
                        </div>
                        <script src="https://cdn.jsdelivr.net/npm/wavesurfer.js"></script>
                        <script src="https://crowdmesh.github.io/wsplaylist/playlist.js"></script>
                        <script>
                            document.addEventListener('DOMContentLoaded', function () {
                                initializeAudioPlayer();
                                setupEventListeners();
                            });
                        </script>
                    </textarea>
                    <button id="copy-embed-code-btn" class="btn">Copy Embed Code</button>
                </div>
            </div>

            <style>
                /* Modal styles */
                .modal {
                    display: none;
                    position: fixed;
                    z-index: 1;
                    padding-top: 100px;
                    left: 0;
                    top: 0;
                    width: 100%;
                    height: 100%;
                    overflow: auto;
                    background-color: rgb(0, 0, 0);
                    background-color: rgba(0, 0, 0, 0.4);
                }

                .modal-content {
                    background-color: #fefefe;
                    margin: auto;
                    padding: 20px;
                    border: 1px solid #888;
                    width: 80%;
                    max-width: 500px;
                }

                .close-modal {
                    color: #aaa;
                    float: right;
                    font-size: 28px;
                    font-weight: bold;
                }

                .close-modal:hover,
                .close-modal:focus {
                    color: black;
                    text-decoration: none;
                    cursor: pointer;
                }
            </style>
        </div>

        <!-- Setup section -->
        <div id="setup-section">
            <h1>Playlist Setup</h1>

            <form id="playlist-setup-form">
                <!-- Album Name -->
                <div>
                    <label for="album-name">Album Name:</label>
                    <input type="text" id="album-name" placeholder="Enter album name" required
                        oninput="updatePreview()">
                </div>

                <!-- Album Art Upload -->
                <div>
                    <label for="album-art">Album Art URL:</label>
                    <input type="text" id="album-art" placeholder="Album Art URL" onchange="updateAlbumArtPreview()"
                        required>
                </div>

                <!-- Toggle for light/dark theme -->
                <div id="theme-selector">
                    <label for="theme-toggle">Theme:</label>
                    <button type="button" id="theme-toggle" onclick="toggleTheme()">Switch to Light Theme</button>
                </div>

                <!-- Add Track -->
                <div>
                    <h3>Add Track</h3>
                    <div class="track-upload">
                        <label for="artist-name">Artist Name:</label>
                        <input type="text" id="artist-name" placeholder="Artist Name" required>
                        <label for="track-name">Track Title:</label>
                        <input type="text" id="track-name" placeholder="Track Title" required>
                        <label for="track-url">Track URL:</label>
                        <input type="text" id="track-url" placeholder="Track URL" required>
                        <button type="button" onclick="addTrack()">Add Track</button>
                    </div>
                </div>

                <!-- Track List -->
                <h3>Track List</h3>
                <div id="track-list">
                    <!-- Tracks will be added here -->
                </div>
            </form>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.14.0/Sortable.min.js"></script>
    <script src="https://unpkg.com/wavesurfer.js@7"></script>
    <script>

        // Function to toggle between dark and light theme
        function toggleTheme() {
            const body = document.body;
            const themeToggleBtn = document.getElementById('theme-toggle');

            body.classList.toggle('light-theme');

            if (body.classList.contains('light-theme')) {
                themeToggleBtn.textContent = 'Switch to Dark Theme';
            } else {
                themeToggleBtn.textContent = 'Switch to Light Theme';
            }
        }

        // Update album and artist name preview
        function updatePreview() {
            const albumName = document.getElementById('album-name').value || "Album Name";
            document.getElementById('preview-album-name').textContent = albumName;
        }

        // Update album art preview
        function updateAlbumArtPreview() {
            const albumArtInput = document.getElementById('album-art');
            const albumArtPreview = document.getElementById('album-art-preview');

            const albumArtUrl = albumArtInput.value.trim(); // Get the entered URL
            if (albumArtUrl) {
                albumArtPreview.src = albumArtUrl; // Set the image source to the entered URL
            } else {
                albumArtPreview.src = "https://via.placeholder.com/100"; // Fallback to a placeholder if the field is empty
            }
        }


        let trackCounter = 0;
        let tracksData = []; // Global array to store track data
        const trackListContainer = document.getElementById('track-list');  // Setup section track list
        const previewTrackList = document.getElementById('tracklist');  // Preview section track list

        // Initialize the default tracks in both the setup and preview sections
        function initializeDefaultTracks() {
            // Prepopulate the track list with default Track 1 and Track 2
            addTrackToList('LIFE OF THE PARTY', 'LaBella Beats', 'https://storage.googleapis.com/msgsndr/5KgPcYXxhFJNe6A0vTLj/media/66e6319aef9d1e15274e0579.mpeg', false);
            addTrackToList('FUTURE', 'LaBella Beats', 'https://storage.googleapis.com/msgsndr/5KgPcYXxhFJNe6A0vTLj/media/66e6319a6d0fa66e8d34d022.mpeg', false);
            addTrackToList('KATANA', 'LaBella Beats', 'https://storage.googleapis.com/msgsndr/5KgPcYXxhFJNe6A0vTLj/media/66e6319a6d0fa654f934d021.mpeg', false);

        }


        // Add track to both the setup and preview sections
        function addTrackToList(trackName, artistName, trackUrl) {
            trackCounter++;
            const trackId = `track-${trackCounter}`;

            // Store track data in the array
            tracksData.push({
                trackId,
                trackName,
                artistName,
                trackUrl,
                trackTime: "Loading..." // Track time will be updated later
            });

            // Rebuild the setup and preview sections
            rebuildSetupSection();
            rebuildPreviewSection();

            // After rebuilding, re-initialize audio player to bind the events to the new track
            initializeAudioPlayer();

        }

        // Fetch the track duration using an audio element
        function fetchTrackDuration(trackUrl, trackCounter) {
            const audio = new Audio(trackUrl);

            // Error handling for failed loading
            audio.addEventListener('error', function () {
                const timeElement = document.getElementById(`track-time-${trackCounter}`);
                timeElement.textContent = "Error loading time";
            });

            // Fetch the duration once the metadata is loaded
            audio.addEventListener('loadedmetadata', function () {
                const trackTime = formatTime(audio.duration);
                const timeElement = document.getElementById(`track-time-${trackCounter}`);
                timeElement.textContent = trackTime;

                // Update track time in global tracksData array
                tracksData[trackCounter - 1].trackTime = trackTime; // Update time in the correct index

            });
        }


        // Format time in MM:SS format
        function formatTime(timeInSeconds) {
            const minutes = Math.floor(timeInSeconds / 60);
            const seconds = Math.floor(timeInSeconds % 60).toString().padStart(2, '0');
            return `${minutes}:${seconds}`;
        }

        // Rebuild the setup section using tracksData
        function rebuildSetupSection() {
            trackListContainer.innerHTML = ''; // Clear current setup section
            tracksData.forEach((track, index) => {
                const trackItem = document.createElement('div');
                trackItem.classList.add('track-item');
                trackItem.id = track.trackId;
                trackItem.innerHTML = `
                    <span><strong>${track.trackName}</strong></span>
                    <button type="button" class="delete-btn" onclick="deleteTrack('${track.trackId}')"><i class="fa-solid fa-xmark"></i></button>
                `;
                trackListContainer.appendChild(trackItem);
            });
        }

        // Rebuild the preview section using tracksData
        function rebuildPreviewSection() {
            previewTrackList.innerHTML = ''; // Clear current preview section
            tracksData.forEach((track, index) => {
                const trackPreviewItem = document.createElement('li');
                trackPreviewItem.setAttribute('data-url', track.trackUrl);
                trackPreviewItem.id = `track-preview-${index + 1}`;
                trackPreviewItem.innerHTML = `
                    <div class="track-number">
                        <img id="track-play-icon-${index + 1}" class="track-play-icon" src="https://storage.googleapis.com/msgsndr/5KgPcYXxhFJNe6A0vTLj/media/66e094e7ea125b3b69e4aa59.svg" alt="Play" style="display: none;">
                        <img id="track-pause-icon-${index + 1}" class="track-pause-icon" src="https://storage.googleapis.com/msgsndr/5KgPcYXxhFJNe6A0vTLj/media/66e094e730211d65ad550edf.svg" alt="Pause" style="display: none;">
                        <span class="track-number-text">${index + 1}</span>
                    </div>
                    <div class="track-details">
                        <span class="track-title">${track.trackName}</span>
                        <span class="track-artist">${track.artistName}</span>
                    </div>
                    <span id="track-time-${index + 1}" class="track-time">${track.trackTime}</span>
                `;
                previewTrackList.appendChild(trackPreviewItem);

                // Fetch the audio duration and update the preview with the correct time
                fetchTrackDuration(track.trackUrl, index + 1);
            });

        }

        // Update tracksData order based on the new visual order
        function updateTrackDataOrder() {
            const trackItems = document.querySelectorAll('.track-item'); // In the setup section
            tracksData = Array.from(trackItems).map((item, index) => {
                const trackId = item.id;
                const track = tracksData.find(track => track.trackId === trackId);
                return {
                    trackId: track.trackId,
                    trackName: track.trackName,
                    artistName: track.artistName,
                    trackUrl: track.trackUrl,
                    trackTime: track.trackTime
                };
            });
        }

        function addTrack() {
            const trackName = document.getElementById('track-name').value;
            const artistName = document.getElementById('artist-name').value;
            const trackUrl = document.getElementById('track-url').value;

            if (!trackName || !artistName || !trackUrl) {
                alert('Please fill in all track details.');
                return;
            }

            // Add track to both the setup and preview sections
            addTrackToList(trackName, artistName, trackUrl, false);

            // Reset the form fields after adding the track
            document.getElementById('track-name').value = '';
            document.getElementById('track-url').value = '';
        }



        // Delete a track from both sections
        function deleteTrack(trackId) {
            tracksData = tracksData.filter(track => track.trackId !== trackId);
            rebuildSetupSection();
            rebuildPreviewSection();
        }

        // Renumber tracks after reordering
        function renumberTracks() {
            const trackItems = document.querySelectorAll('.track-item'); // In the setup section

            // Update `tracksData` to reflect the new visual order
            tracksData = Array.from(trackItems).map((item, index) => {
                const trackId = item.id;  // Get the trackId from the HTML element
                const track = tracksData.find(track => track.trackId === trackId); // Find the track in the original data
                return {
                    ...track,  // Preserve all the existing track data
                    trackId: `track-${index + 1}`  // Update the trackId to reflect the new order
                };
            });

            // Rebuild the preview section to reflect the new order
            rebuildPreviewSection(); // Ensure the preview section is updated after renumbering
            updatePreviewOrder();

            // Re-initialize the audio player after reordering
            initializeAudioPlayer(); // Make sure to call this so the player works with the new order
        }


        // Function to update preview order based on global track data
        function updatePreviewOrder() {
            const previewTrackList = document.getElementById('tracklist'); // Preview section list

            // Clear the preview list
            previewTrackList.innerHTML = '';

            // Loop through the updated track data and rebuild the preview section
            tracksData.forEach((track, index) => {
                const trackNumber = index + 1;

                // Create the preview item dynamically
                const newPreviewItem = document.createElement('li');
                newPreviewItem.setAttribute('data-url', track.trackUrl); // Re-assign the data-url attribute here
                newPreviewItem.id = `track-preview-${trackNumber}`;

                newPreviewItem.innerHTML = `
                    <div class="track-number">
                        <img id="track-play-icon-${index + 1}" class="track-play-icon" src="https://storage.googleapis.com/msgsndr/5KgPcYXxhFJNe6A0vTLj/media/66e094e7ea125b3b69e4aa59.svg" alt="Play" style="display: none;">
                        <img id="track-pause-icon-${index + 1}" class="track-pause-icon" src="https://storage.googleapis.com/msgsndr/5KgPcYXxhFJNe6A0vTLj/media/66e094e730211d65ad550edf.svg" alt="Pause" style="display: none;">
                        <span class="track-number-text">${trackNumber}</span>
                    </div>
                    <div class="track-details">
                        <span class="track-title">${track.trackName}</span>
                        <span class="track-artist">${track.artistName}</span>
                    </div>
                    <span id="track-time-${trackNumber}" class="track-time">${track.trackTime}</span>
                `;

                // Append the newly created item to the preview list
                previewTrackList.appendChild(newPreviewItem);

                // Fetch the audio duration and reload the track in case of reordering
                fetchTrackDuration(track.trackUrl, trackNumber);
            });
        }


        // Update the preview section based on the track list
        function updatePreviewSection() {
            const albumName = document.getElementById('album-name').value || "Album Name";
            const artistName = document.getElementById('artist-name').value || "Artist Name";

            document.getElementById('preview-album-name').textContent = albumName;
            document.getElementById('preview-artist-name').textContent = artistName;

            // Additional logic can be added here to load the tracks into the preview player.
        }

           /////////////////////////////////////
          ////////// .  ////////     //////////
         //////////     //////// .   /////////
        /////////////////////////////////////
        ////////////////////////////////////
        /////////               ///////////
        /////////               //////////
        /////////               /////////
        ////////////////////////////////
        ///////////////////////////////  // //
        /////////////////////////////////////
        ///////////////////////////////////
        /////////////////////////////////
        ///////////////////////////////
        /////////////////////////////


        // Update both play/pause buttons globally
        function updateIcons(isPlaying, track) {
            // Main player control icons
            const playIcon = document.getElementById("play-icon");
            const pauseIcon = document.getElementById("pause-icon");

            if (isPlaying) {
                playIcon.style.display = "none";
                pauseIcon.style.display = "block";
            } else {
                playIcon.style.display = "block";
                pauseIcon.style.display = "none";
            }

            // Individual track icons
            if (track) {
                const trackPlayIcon = track.querySelector(".track-play-icon");
                const trackPauseIcon = track.querySelector(".track-pause-icon");
                const trackNumberText = track.querySelector(".track-number-text");

                if (isPlaying) {
                    trackNumberText.style.display = "none";
                    trackPlayIcon.style.display = "none";
                    trackPauseIcon.style.display = "inline-block";
                } else {
                    trackNumberText.style.display = "none";
                    trackPlayIcon.style.display = "inline-block";
                    trackPauseIcon.style.display = "none";
                }
            }
        }

        // Function to reset icons for all tracks
        function resetAllTrackIcons(trackItems) {
            trackItems.forEach(function (track) {
                const playIcon = track.querySelector(".track-play-icon");
                const pauseIcon = track.querySelector(".track-pause-icon");
                const trackNumberText = track.querySelector(".track-number-text");

                trackNumberText.style.display = "block";
                playIcon.style.display = "none";
                pauseIcon.style.display = "none";
                track.classList.remove("playing");
            });
        }

        // Get the buttons outside of initializeAudioPlayer
        const playPauseButton = document.getElementById("play-pause-btn");
        const prevButton = document.getElementById("prev-btn");
        const nextButton = document.getElementById("next-btn");
        let trackItems = []; // Declare trackItems globally to be used throughout

        // Set up the event listeners once
        function setupEventListeners() {
            // Ensure existing listeners are not added multiple times
            playPauseButton.addEventListener("click", function () {
                if (currentPlayingWaveSurfer) {
                    if (currentPlayingWaveSurfer.isPlaying()) {
                        currentPlayingWaveSurfer.pause();
                        updateIcons(false, currentPlayingTrack); // Update both main and track icons
                    } else {
                        currentPlayingWaveSurfer.play();
                        updateIcons(true, currentPlayingTrack); // Update both main and track icons
                    }
                } else {
                    // If no track is currently loaded, load and play the first one
                    const firstTrack = trackItems[currentTrackIndex];
                    stopAndLoadTrack(currentTrackIndex);
                    updateIcons(true, firstTrack);
                }
            });

            nextButton.addEventListener("click", function () {
                // Increment track index and ensure it loops around properly
                console.log("Before Next Click: currentTrackIndex = ", currentTrackIndex);
                currentTrackIndex = (currentTrackIndex + 1) % trackItems.length;
                console.log("After Next Click: currentTrackIndex = ", currentTrackIndex);
                stopAndLoadTrack(currentTrackIndex); // Load the next track
            });

            prevButton.addEventListener("click", function () {
                // Decrement track index and ensure it loops around properly
                console.log("Before Prev Click: currentTrackIndex = ", currentTrackIndex);
                currentTrackIndex = (currentTrackIndex - 1 + trackItems.length) % trackItems.length;
                console.log("After Prev Click: currentTrackIndex = ", currentTrackIndex);
                stopAndLoadTrack(currentTrackIndex); // Load the previous track
            });
        }

        // Stop the current track and load a new one
        function stopAndLoadTrack(index) {
            let selectedTrack = trackItems[index]; // Get the selected track based on index
            let trackUrl = selectedTrack.getAttribute("data-url"); // Fetch the track URL

            // Get the single waveform container
            let container = document.querySelector(".waveform-container");

            // Ensure the container is available before creating WaveSurfer
            if (!container) {
                console.error("Waveform container not found.");
                return; // Stop further execution if the container is not found
            }

            // Clear the existing waveform content
            container.innerHTML = "";

            // Destroy the previous WaveSurfer instance directly from the container
            if (container.wavesurfer) {
                container.wavesurfer.destroy(); // Destroy the existing instance
                container.wavesurfer = null; // Clear the reference
            }

            // Create a new WaveSurfer instance for the new track using the single container
            let wavesurfer = WaveSurfer.create({
                container: container, // Use the single container
                waveColor: "#575757",
                progressColor: "#a9a9a9",
                cursorColor: "#FFFFFF",
                barWidth: 1,
                height: 64,
                minPxPerSec: 10,
                responsive: 100,
                hideScrollbar: true
            });

            // Assign the new WaveSurfer instance to the container
            container.wavesurfer = wavesurfer;

            // Load the new track into the newly created WaveSurfer instance
            wavesurfer.load(trackUrl);

            // Play the track when it's ready
            wavesurfer.on("ready", function () {
                wavesurfer.play(); // Start playing the track immediately when it's ready
                updateIcons(true, selectedTrack); // Update the UI to reflect the playing state
            });

            // Automatically play the next track when this one finishes
            wavesurfer.on('finish', function () {
                console.log("Track finished: Auto-playing next track");
                currentTrackIndex = (currentTrackIndex + 1) % trackItems.length;
                stopAndLoadTrack(currentTrackIndex); // Load the next track
            });

            // Reset the UI for all tracks and update the current track's UI
            resetAllTrackIcons(trackItems);
            selectedTrack.classList.add("playing"); // Mark the new track as playing
            currentPlayingTrack = selectedTrack; // Set the new track as the current playing track
            currentPlayingWaveSurfer = wavesurfer; // Update the global reference to the new instance
        }

        //WaveSurfer Logic
        let currentTrackIndex = 0; // Track the currently playing track index
        var currentPlayingWaveSurfer = null; // To keep track of the currently playing WaveSurfer instance
        var currentPlayingTrack = null; // To keep track of the currently playing track

        function initializeAudioPlayer() {
            var waveformContainers = document.querySelectorAll(".waveform-container");
            trackItems = document.querySelectorAll("#tracklist li");
            waveformContainers.forEach(function (container) {
                // If there's an existing WaveSurfer instance in the container, destroy it
                if (container.wavesurfer) {
                    container.wavesurfer.destroy();  // Destroy the existing instance
                    container.innerHTML = "";  // Clear the container element's content (the waveform)
                }

                var wavesurfer = WaveSurfer.create({
                    container: container,
                    waveColor: "#575757",
                    progressColor: "#a9a9a9",
                    cursorColor: "#FFFFFF",
                    barWidth: 1,
                    height: 64,
                    minPxPerSec: 10,
                    responsive: 100,
                    hideScrollbar: true
                });

                // Attach the new WaveSurfer instance to the container so it can be accessed later
                container.wavesurfer = wavesurfer;

                // Load the first track waveform but don't autoplay
                let audioSrc = trackItems[currentTrackIndex].getAttribute("data-url");
                console.log("Loading first track:", audioSrc);
                wavesurfer.load(audioSrc);
                currentPlayingTrack = trackItems[currentTrackIndex];
                currentPlayingWaveSurfer = wavesurfer;

                // Ensure the UI shows the play state correctly after initialization
                updateIcons(false, currentPlayingTrack);

                // Tracklist interaction
                trackItems.forEach(function (track, index) {
                    track.addEventListener("mouseenter", function () {
                        if (!track.classList.contains("playing")) {
                            var playIcon = track.querySelector(".track-play-icon");
                            var trackNumberText = track.querySelector(".track-number-text");
                            var pauseIcon = track.querySelector(".track-pause-icon");
                            trackNumberText.style.display = "none";
                            playIcon.style.display = "inline-block";
                            pauseIcon.style.display = "none";
                        }
                    });

                    track.addEventListener("mouseleave", function () {
                        if (!track.classList.contains("playing")) {
                            var playIcon = track.querySelector(".track-play-icon");
                            var trackNumberText = track.querySelector(".track-number-text");
                            var pauseIcon = track.querySelector(".track-pause-icon");
                            trackNumberText.style.display = "block";
                            playIcon.style.display = "none";
                            pauseIcon.style.display = "none";
                        }
                    });

                    track.addEventListener("click", function () {
                        console.log("Track clicked: Index = ", index, "URL = ", track.getAttribute("data-url"));
                        if (currentPlayingTrack !== track) {
                            // Use stopAndLoadTrack to handle loading and playing the selected track
                            stopAndLoadTrack(index);
                        } else {
                            // Toggle play/pause for the currently playing track
                            if (currentPlayingWaveSurfer.isPlaying()) {
                                currentPlayingWaveSurfer.pause();
                                updateIcons(false, track); // Update both main and track icons
                            } else {
                                currentPlayingWaveSurfer.play();
                                updateIcons(true, track); // Update both main and track icons
                            }
                        }
                    });
                });

                // Error handling in case of loading errors
                wavesurfer.on("error", function (e) {
                    console.error("WaveSurfer Error:", e);
                });
            });
        }

        // Only call this function once after initializing tracks
        setupEventListeners();

        // Function to get the selected theme
        function getSelectedTheme() {
            return document.body.classList.contains('light-theme') ? 'light-theme' : 'default-theme';
        }


        // Function to generate the embed code dynamically using Mustache.js
        function generateEmbedCode() {
            const selectedTheme = getSelectedTheme();
            let themeClass = selectedTheme === 'light-theme' ? 'light-theme' : '';
            // Get the player HTML
            const playerContainer = document.getElementById('player-container');
            if (!playerContainer) {
                console.error('Player container not found.');
                return;
            }
            const playerHtml = playerContainer.outerHTML;

            // Get the existing content of the textarea
            const embedTextarea = document.getElementById('embed-code-textarea');
            let embedCode = embedTextarea.value;

            // Add theme class to the playlist widget container dynamically
            embedCode = embedCode.replace('<div id="playlist-widget">',
                `<div id="playlist-widget" class="${themeClass}">`);

            // Insert the playerHtml where the placeholder is
            embedCode = embedCode.replace('<!-- PLAYER_HTML_PLACEHOLDER -->', playerHtml);

            // Update the textarea with the final embed code
            embedTextarea.value = embedCode;
        }


        // Function to copy the embed code to the clipboard
        function copyEmbedCode() {
            const embedTextarea = document.getElementById('embed-code-textarea');
            embedTextarea.select();
            document.execCommand('copy');
            alert('Embed code copied to clipboard!');
        }


        // Function to show the modal
        function showModal() {
            const modal = document.getElementById('embed-modal');
            modal.style.display = 'block';
            generateEmbedCode();  // Generate the embed code when the modal is shown
        }

        // Function to close the modal
        function closeModal() {
            const modal = document.getElementById('embed-modal');
            modal.style.display = 'none';
        }

        // Event listeners
        document.getElementById('embed-button').addEventListener('click', showModal);
        document.getElementById('copy-embed-code-btn').addEventListener('click', copyEmbedCode);
        document.querySelector('.close-modal').addEventListener('click', closeModal);

        // Close modal if clicked outside the modal content
        window.onclick = function (event) {
            const modal = document.getElementById('embed-modal');
            if (event.target == modal) {
                modal.style.display = 'none';
            }
        };



        // Consolidated DOMContentLoaded listener
        document.addEventListener("DOMContentLoaded", function () {
            initializeDefaultTracks();
            updatePreviewSection();

            // Initialize Sortable for the setup section
            var setupList = document.getElementById('track-list');
            new Sortable(setupList, {
                animation: 150, // Animation speed
                onEnd: function () {
                    renumberTracks(); // Re-number the tracks after reordering
                }
            });

            document.getElementById('embed-button').addEventListener('click', showModal);
            document.getElementById('copy-embed-code-btn').addEventListener('click', copyEmbedCode);



        });



    </script>

    <script id="embed-template" type="x-tmpl-mustache">
    <div class="embedded-player-container">
        <link rel="stylesheet" href="https://crowdmesh.github.io/wsplaylist/playlist.css">
        <div class="player-container">
            {{{playerHtml}}}
        </div>
    </div>
</script>







</body>

</html>
